{% extends "layout.html" %}

{% block title %}
Study
{% endblock %}

{% block body %}
<div class="top">
    <a href="/">Cancel</a>
</div>

<div class="middle">
    <h3 class="study-h3" style="margin-top: 110px">{{ task.name }}</h3>
    <h2 class="study-h2" id="countdown-timer"></h2>
    <h3 class="study-h3" id="task-repetition"></h3>
    <h3 class="study-h3" id="phase"></h3>
</div>
<div class="bottom">
    <form action="/study" id="done-form" method="post" style="padding: 0;">
        <input name="name" type="hidden" value="{{ task.name }}">
        <input id="total-work-time" name="total-work-time" type="hidden">
    </form>
</div>
<audio id="sound" src="/static/beep.mp3"></audio>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const workTime = Number(urlParams.get("work-time"));
    const repetition = Number(urlParams.get("repetition"));
    const restTime = Number(urlParams.get("rest-time"));
    const totalWorkTime = String(workTime * repetition);
    // console.log(totalWorkTime);

    let currentRep = 1;
    let phase = "work";
    let timeLeft = workTime * 60;
    let timerId;
    const sound = document.getElementById("sound");

    function updateDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = String(timeLeft % 60).padStart(2, "0");
        document.getElementById("countdown-timer").textContent = `${ m }:${ s }`;
        document.getElementById("task-repetition").textContent = `${ currentRep }/${ repetition }`;
        document.getElementById("phase").textContent = `${ phase }`;
    }

    function tick() {
        if (timeLeft > 0) {
            timeLeft--;
            updateDisplay();
        } else {
            clearInterval(timerId);

            if (phase === "work") {
                if (currentRep >= repetition) {
                    document.getElementById("countdown-timer").textContent = "All done!";
                    document.getElementById("total-work-time").value = totalWorkTime;
                    sound.play();
                    setTimeout(() => {
                        document.getElementById("done-form").submit();
                    }, 2500);
                    return;
                }
                phase = "rest";
                timeLeft = restTime * 60;
            } else {
                currentRep++;
                phase = "work";
                timeLeft = workTime * 60;
            }

            sound.play();
            updateDisplay();
            timerId = setInterval(tick, 1000);
        }
    }

    updateDisplay();
    timerId = setInterval(tick, 1000);
</script>

{% endblock %}